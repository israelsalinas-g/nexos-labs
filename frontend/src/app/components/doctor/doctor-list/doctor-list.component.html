<div class="container">
  <div class="header">
    <div class="header-left">
      <h1>Gesti√≥n de M√©dicos</h1>
    </div>
    <div class="header-center">
      <div class="search-controls">
        <input type="text" placeholder="Buscar por nombre, especialidad o licencia..." [ngModel]="searchTerm()"
          (ngModelChange)="searchTerm.set($event)" (input)="onSearch()" class="search-input">
        <button class="btn-secondary" (click)="clearSearch()">Limpiar</button>
        <select [ngModel]="statusFilter()" (ngModelChange)="statusFilter.set($event); onStatusFilterChange()"
          class="filter-select">
          <option value="">Todos los estados</option>
          <option value="active">Solo activos</option>
          <option value="inactive">Solo inactivos</option>
        </select>
      </div>
    </div>
    <div class="header-right">
      <button class="btn-primary" (click)="openCreateModal()">
        + Nuevo M√©dico
      </button>
    </div>
  </div>

  @if (loading()) {
  <div class="loading">Cargando m√©dicos...</div>
  }

  @if (error()) {
  <div class="error">Error: {{ error() }}</div>
  }

  @if (!loading() && !error()) {
  <div class="table-container">
    <table class="doctors-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Especialidad</th>
          <th>Tel√©fono</th>
          <th>Staff</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (doctor of doctors(); track doctor.id) {
        <tr [class.inactive]="!doctor.isActive">
          <td>{{ doctor.firstName }} {{ doctor.lastName }}</td>
          <td>{{ doctor.specialty }}</td>
          <td>{{ doctor.phone }}</td>
          <td>
            <span class="badge" [class]="doctor.isStaff ? 'badge-staff' : 'badge-external'">
              {{ doctor.isStaff ? 'S√≠' : 'No' }}
            </span>
          </td>
          <td>
            <span class="status-badge" [class]="doctor.isActive ? 'active' : 'inactive'">
              {{ doctor.isActive ? 'Activo' : 'Inactivo' }}
            </span>
          </td>
          <td class="actions">
            <button class="action-btn view-btn" (click)="viewDoctor(doctor)" title="Ver detalles">üëÅÔ∏è Ver</button>
            <button class="action-btn edit-btn" (click)="openEditModal(doctor)" title="Editar m√©dico">‚úèÔ∏è Editar</button>
            <button class="action-btn" [class.status-active-btn]="doctor.isActive"
              [class.status-inactive-btn]="!doctor.isActive" (click)="toggleStatus(doctor)"
              [title]="doctor.isActive ? 'Desactivar m√©dico' : 'Activar m√©dico'">
              {{ doctor.isActive ? 'üî¥ Desactivar' : 'üü¢ Activar' }}
            </button>
            @if (!doctor.isActive) {
            <button class="action-btn delete-btn" (click)="deleteDoctor(doctor)" title="Eliminar m√©dico">
              üóëÔ∏è Eliminar
            </button>
            }
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="6" class="no-data-td">
            @if (searchTerm()) { No se encontraron m√©dicos que coincidan con "{{ searchTerm() }}" }
            @else { No hay m√©dicos registrados. }
          </td>
        </tr>
        }
      </tbody>
    </table>

    @if (totalPages() > 1) {
    <div class="pagination">
      <button class="btn" (click)="goToPage(currentPage() - 1)" [disabled]="currentPage() === 1">
        ‚Üê Anterior
      </button>
      <span class="page-info">P√°gina {{ currentPage() }} de {{ totalPages() }} ({{ totalItems() }} m√©dicos
        totales)</span>
      <button class="btn" (click)="goToPage(currentPage() + 1)" [disabled]="currentPage() === totalPages()">
        Siguiente ‚Üí
      </button>
    </div>
    }
  </div>
  }

  <!-- Modal de confirmaci√≥n -->
  @if (showConfirmModal()) {
  <div class="modal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>{{ confirmAction().title }}</h3>
      <p>{{ confirmAction().message }}</p>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeModal()">Cancelar</button>
        <button class="btn-danger" (click)="confirmAction().action()">Confirmar</button>
      </div>
    </div>
  </div>
  }

  <!-- Modal de detalles -->
  @if (selectedDoctor() && !isEditMode()) {
  <div class="modal" (click)="closeDoctorModal()">
    <div class="modal-content large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalles del M√©dico</h3>
        <button class="close-btn" (click)="closeDoctorModal()">√ó</button>
      </div>
      <div class="doctor-details">
        <div class="detail-section">
          <h4>Informaci√≥n Personal</h4>
          <div class="detail-grid">
            <div><strong>Nombre:</strong> {{ selectedDoctor()!.firstName }}</div>
            <div><strong>Apellido:</strong> {{ selectedDoctor()!.lastName }}</div>
            <div><strong>Especialidad:</strong> {{ selectedDoctor()!.specialty }}</div>
            <div><strong>Licencia:</strong> {{ selectedDoctor()!.licenseNumber }}</div>
            <div><strong>Tel√©fono:</strong> {{ selectedDoctor()!.phone }}</div>
            <div><strong>Email:</strong> {{ selectedDoctor()!.email }}</div>
          </div>
        </div>
        <div class="detail-section">
          <h4>Informaci√≥n Profesional</h4>
          <div class="detail-grid">
            <div><strong>Instituci√≥n:</strong> {{ selectedDoctor()!.institution }}</div>
            <div><strong>Direcci√≥n:</strong> {{ selectedDoctor()!.address }}</div>
            <div><strong>Staff:</strong> {{ selectedDoctor()!.isStaff ? 'S√≠' : 'No' }}</div>
            <div><strong>Estado:</strong> {{ selectedDoctor()!.isActive ? 'Activo' : 'Inactivo' }}</div>
          </div>
        </div>
        @if (selectedDoctor()!.notes) {
        <div class="detail-section">
          <h4>Notas</h4>
          <div class="detail-field">
            <p>{{ selectedDoctor()!.notes }}</p>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
  }

  <!-- Modal crear/editar -->
  @if (showFormModal()) {
  <div class="modal" (click)="closeFormModal()">
    <div class="modal-content large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isEditMode() ? 'Editar M√©dico' : 'Nuevo M√©dico' }}</h3>
        <button class="close-btn" (click)="closeFormModal()">√ó</button>
      </div>
      <form (ngSubmit)="saveDoctor()" #doctorForm="ngForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="firstName">Nombre *</label>
            <input type="text" id="firstName" name="firstName" [ngModel]="formData().firstName"
              (ngModelChange)="formData.set({...formData(), firstName: $event})" required class="form-control">
          </div>
          <div class="form-group">
            <label for="lastName">Apellido *</label>
            <input type="text" id="lastName" name="lastName" [ngModel]="formData().lastName"
              (ngModelChange)="formData.set({...formData(), lastName: $event})" required class="form-control">
          </div>
          <div class="form-group">
            <label for="specialty">Especialidad</label>
            <input type="text" id="specialty" name="specialty" [ngModel]="formData().specialty"
              (ngModelChange)="formData.set({...formData(), specialty: $event})" class="form-control">
          </div>
          <div class="form-group">
            <label for="licenseNumber">N√∫mero de Licencia</label>
            <input type="text" id="licenseNumber" name="licenseNumber" [ngModel]="formData().licenseNumber"
              (ngModelChange)="formData.set({...formData(), licenseNumber: $event})" class="form-control">
          </div>
          <div class="form-group">
            <label for="phone">Tel√©fono</label>
            <input type="tel" id="phone" name="phone" [ngModel]="formData().phone"
              (ngModelChange)="formData.set({...formData(), phone: $event})" class="form-control">
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" [ngModel]="formData().email"
              (ngModelChange)="formData.set({...formData(), email: $event})" class="form-control">
          </div>
          <div class="form-group full-width">
            <label for="address">Direcci√≥n</label>
            <input type="text" id="address" name="address" [ngModel]="formData().address"
              (ngModelChange)="formData.set({...formData(), address: $event})" class="form-control">
          </div>
          <div class="form-group full-width">
            <label for="institution">Instituci√≥n</label>
            <input type="text" id="institution" name="institution" [ngModel]="formData().institution"
              (ngModelChange)="formData.set({...formData(), institution: $event})" class="form-control">
          </div>
          <div class="form-group full-width">
            <label for="notes">Notas</label>
            <textarea id="notes" name="notes" [ngModel]="formData().notes"
              (ngModelChange)="formData.set({...formData(), notes: $event})" rows="3" class="form-control"></textarea>
          </div>
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" name="isStaff" [ngModel]="formData().isStaff"
                (ngModelChange)="formData.set({...formData(), isStaff: $event})">
              Miembro del Staff
            </label>
          </div>
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" name="isActive" [ngModel]="formData().isActive"
                (ngModelChange)="formData.set({...formData(), isActive: $event})">
              Activo
            </label>
          </div>
        </div>
        @if (formError()) {
        <div class="form-error">{{ formError() }}</div>
        }
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeFormModal()">Cancelar</button>
          <button type="submit" class="btn-primary" [disabled]="!doctorForm.form.valid || saving()">
            {{ saving() ? 'Guardando...' : (isEditMode() ? 'Actualizar' : 'Crear') }}
          </button>
        </div>
      </form>
    </div>
  </div>
  }
</div>