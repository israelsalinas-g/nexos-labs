<div class="container">
  <div class="header">
    <div class="header-left">
      <h1>Generales de Orina</h1>
    </div>
    <button class="btn btn-primary" routerLink="/urine-tests/new">
      ‚ûï Nuevo Examen
    </button>
  </div>

  @if (loading()) {
  <div class="loading">
    üîÑ Cargando ex√°menes de orina...
  </div>
  }

  @if (error()) {
  <div class="error">
    ‚ùå Error: {{ error() }}
    <br><small>Verifica que el backend est√© ejecut√°ndose en http://localhost:3000</small>
  </div>
  }

  @if (successMessage()) {
  <div class="success">
    ‚úÖ {{ successMessage() }}
  </div>
  }

  <!-- Filters Section -->
  @if (!loading() && !error()) {
  <div class="filters">
    <div class="filter-group">
      <label for="statusFilter">Estado:</label>
      <select id="statusFilter" [ngModel]="filters().status"
        (ngModelChange)="updateFilters('status', $event); applyFilters()">
        <option value="">Todos los estados</option>
        @for (option of statusOptions; track option.value) {
        <option [value]="option.value">{{ option.label }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="dateFromFilter">Desde:</label>
      <input id="dateFromFilter" type="date" class="form-control" [ngModel]="filters().dateFrom"
        (ngModelChange)="updateFilters('dateFrom', $event); applyFilters()">
    </div>

    <div class="filter-group">
      <label for="dateToFilter">Hasta:</label>
      <input id="dateToFilter" type="date" class="form-control" [ngModel]="filters().dateTo"
        (ngModelChange)="updateFilters('dateTo', $event); applyFilters()">
    </div>

    <div class="filter-group checkbox-group">
      <label>
        <input type="checkbox" [ngModel]="filters().hasAbnormalResults"
          (ngModelChange)="updateFilters('hasAbnormalResults', $event); applyFilters()">
        Resultados anormales
      </label>
    </div>

    <div class="filter-actions">
      <button class="btn btn-secondary" (click)="clearFilters()">
        üóëÔ∏è Limpiar Filtros
      </button>
    </div>
  </div>
  }

  <!-- Results Table -->
  @if (!loading() && !error() && urineTests().length > 0) {
  <div class="table-container">
    <table class="results-table">
      <thead>
        <tr>
          <th (click)="sort('patient.name')">
            Paciente
            <span class="sort-indicator" [class.active]="sortField() === 'patient.name'">
              {{ sortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
          </th>
          <th (click)="sort('testDate')">
            Fecha Examen
            <span class="sort-indicator" [class.active]="sortField() === 'testDate'">
              {{ sortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
          </th>
          <th>Examen F√≠sico</th>
          <th>Examen Qu√≠mico</th>
          <th>Microsc√≥pico</th>
          <th (click)="sort('status')">
            Estado
            <span class="sort-indicator" [class.active]="sortField() === 'status'">
              {{ sortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
          </th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (test of urineTests(); track test.id) {
        <tr [class.abnormal-row]="hasAbnormalResults(test)" [class.inactive-row]="!test.isActive">
          <td>
            <div class="patient-info">
              <strong>{{ test.patient?.name || 'Paciente no disponible' }}</strong>
              @if (test.patient?.age) {
              <small>{{ test.patient?.age }} a√±os</small>
              }
            </div>
          </td>
          <td>
            <div class="date-info">
              <strong>{{ formatDate(test.testDate) }}</strong>
            </div>
          </td>
          <td>
            <div class="physical-results">
              @if (test.color) {
              <div class="result-item">
                <span class="label">Color:</span>
                <span class="value" [class]="getColorClass(test.color)">{{ test.color }}</span>
              </div>
              }
              @if (test.aspect) {
              <div class="result-item">
                <span class="label">Aspecto:</span>
                <span class="value">{{ test.aspect }}</span>
              </div>
              }
              @if (test.volume) {
              <div class="result-item">
                <span class="label">Volumen:</span>
                <span class="value">{{ test.volume }}</span>
              </div>
              }
              @if (!hasPhysicalResults(test)) {
              <span class="no-data">Sin datos</span>
              }
            </div>
          </td>
          <td>
            <div class="chemical-results">
              @if (test.protein) {
              <div class="result-item">
                <span class="label">Prote√≠na:</span>
                <span class="value" [class]="getResultClass(test.protein)">{{ test.protein }}</span>
              </div>
              }
              @if (test.glucose) {
              <div class="result-item">
                <span class="label">Glucosa:</span>
                <span class="value" [class]="getResultClass(test.glucose)">{{ test.glucose }}</span>
              </div>
              }
              @if (test.bilirubin) {
              <div class="result-item">
                <span class="label">Bilirrubina:</span>
                <span class="value" [class]="getResultClass(test.bilirubin)">{{ test.bilirubin }}</span>
              </div>
              }
              @if (!hasChemicalResults(test)) {
              <span class="no-data">Sin datos</span>
              }
            </div>
          </td>
          <td>
            <div class="microscopic-results">
              @if (test.bacteria) {
              <div class="result-item">
                <span class="label">Bacterias:</span>
                <span class="value" [class]="getBacteriaClass(test.bacteria)">{{ test.bacteria }}</span>
              </div>
              }
              @if (test.epithelialCells) {
              <div class="result-item">
                <span class="label">C√©lulas Epiteliales:</span>
                <span class="value">{{ test.epithelialCells }}</span>
              </div>
              }
              @if (!hasMicroscopicResults(test)) {
              <span class="no-data">Sin datos</span>
              }
            </div>
          </td>
          <td>
            <span class="status" [class]="getStatusClass(test.status)">
              {{ getStatusText(test.status) }}
            </span>
            @if (hasAbnormalResults(test)) {
            <div class="abnormal-indicator">
              ‚ö†Ô∏è Anormal
            </div>
            }
          </td>
          <td>
            <div class="action-buttons">
              <button class="action-btn view-btn" (click)="viewDetails(test.id)" title="Ver detalle">
                üëÅÔ∏è Ver
              </button>
              <button class="action-btn edit-btn" (click)="editTest(test.id)" title="Editar examen">
                ‚úèÔ∏è Editar
              </button>
              <button class="action-btn" [class.status-active-btn]="test.isActive"
                [class.status-inactive-btn]="!test.isActive" (click)="deleteTest(test.id)"
                [title]="test.isActive ? 'Desactivar examen' : 'Activar examen'">
                {{ test.isActive ? 'üóëÔ∏è Desactivar' : 'üü¢ Activar' }}
              </button>
              <button class="action-btn pdf-btn" (click)="generateReport(test.id)" title="Descargar PDF">
                üñ®Ô∏è PDF
              </button>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  }

  <!-- Pagination -->
  @if (!loading() && !error() && totalPages() > 1) {
  <div class="pagination">
    <button class="btn" [disabled]="currentPage() === 1" (click)="goToPage(currentPage() - 1)">
      ‚Üê Anterior
    </button>

    <span class="page-info">
      P√°gina {{ currentPage() }} de {{ totalPages() }}
      ({{ totalItems() }} ex√°menes)
    </span>

    <button class="btn" [disabled]="currentPage() === totalPages()" (click)="goToPage(currentPage() + 1)">
      Siguiente ‚Üí
    </button>
  </div>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && urineTests().length === 0) {
  <div class="empty-state">
    <p>üß™ No hay ex√°menes de orina disponibles</p>
    <small>Los ex√°menes aparecer√°n aqu√≠ cuando sean creados</small>
    <button class="btn btn-primary" routerLink="/urine-tests/new">
      Crear Primer Examen
    </button>
  </div>
  }

  <!-- Modal de confirmaci√≥n -->
  @if (showConfirmModal()) {
  <div class="modal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>{{ confirmAction().title }}</h3>
      <p>{{ confirmAction().message }}</p>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeModal()">Cancelar</button>
        <button class="btn-danger" (click)="confirmAction().action()">Confirmar</button>
      </div>
    </div>
  </div>
  }
</div>