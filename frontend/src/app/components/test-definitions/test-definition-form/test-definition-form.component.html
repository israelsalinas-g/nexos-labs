
    <div class="modal-overlay" (click)="onCancel()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ isEditMode ? 'Editar Prueba' : 'Nueva Prueba' }}</h2>
          <button class="close-btn" (click)="onCancel()">&times;</button>
        </div>

        <form [formGroup]="testForm" (ngSubmit)="onSubmit()">
          <div class="form-body">
            <!-- Categoría -->
            <div class="form-group">
              <label for="sectionId" class="required">Sección</label>
              <select
                id="sectionId"
                formControlName="sectionId"
                class="form-control"
                [class.invalid]="isFieldInvalid('sectionId')">
                <option value="">Seleccione una sección</option>
                <option *ngFor="let category of categories" [value]="category.id">
                  {{ category.name }}
                </option>
              </select>
              <div class="error-message" *ngIf="isFieldInvalid('sectionId')">
                <span *ngIf="testForm.get('sectionId')?.errors?.['required']">La sección es requerida</span>
              </div>
            </div>

            <!-- Nombre y Código -->
            <div class="form-row">
              <div class="form-group">
                <label for="name" class="required">Nombre</label>
                <input 
                  id="name"
                  type="text" 
                  formControlName="name"
                  class="form-control"
                  placeholder="Ej: Creatinina"
                  [class.invalid]="isFieldInvalid('name')">
                <div class="error-message" *ngIf="isFieldInvalid('name')">
                  <span *ngIf="testForm.get('name')?.errors?.['required']">El nombre es requerido</span>
                  <span *ngIf="testForm.get('name')?.errors?.['minlength']">Mínimo 2 caracteres</span>
                  <span *ngIf="testForm.get('name')?.errors?.['maxlength']">Máximo 150 caracteres</span>
                </div>
              </div>

              <div class="form-group">
                <label for="code">Código</label>
                <input 
                  id="code"
                  type="text" 
                  formControlName="code"
                  class="form-control"
                  placeholder="Ej: CREAT"
                  [class.invalid]="isFieldInvalid('code')">
                <div class="error-message" *ngIf="isFieldInvalid('code')">
                  <span *ngIf="testForm.get('code')?.errors?.['maxlength']">Máximo 20 caracteres</span>
                </div>
              </div>
            </div>

            <!-- Descripción -->
            <div class="form-group">
              <label for="description">Descripción</label>
              <textarea 
                id="description"
                formControlName="description"
                class="form-control"
                rows="2"
                placeholder="Descripción de la prueba"></textarea>
            </div>

            <!-- Tipo de Resultado y Unidad -->
            <div class="form-row">
              <div class="form-group">
                <label for="resultType" class="required">Tipo de Resultado</label>
                <select 
                  id="resultType"
                  formControlName="resultType"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('resultType')">
                  <option value="">Seleccione un tipo</option>
                  <option *ngFor="let type of testResultTypes" [value]="type.value">
                    {{ type.label }}
                  </option>
                </select>
                <div class="error-message" *ngIf="isFieldInvalid('resultType')">
                  <span *ngIf="testForm.get('resultType')?.errors?.['required']">El tipo es requerido</span>
                </div>
              </div>

              <div class="form-group">
                <label for="unit">Unidad</label>
                <input 
                  id="unit"
                  type="text" 
                  formControlName="unit"
                  class="form-control"
                  placeholder="Ej: mg/dL"
                  [class.invalid]="isFieldInvalid('unit')">
                <div class="error-message" *ngIf="isFieldInvalid('unit')">
                  <span *ngIf="testForm.get('unit')?.errors?.['maxlength']">Máximo 50 caracteres</span>
                </div>
              </div>
            </div>

            <!-- Rango de Referencia -->
            <div class="form-group">
              <label for="referenceRange">Rango de Referencia</label>
              <textarea 
                id="referenceRange"
                formControlName="referenceRange"
                class="form-control"
                rows="2"
                placeholder="Ej: Hombres: 0.7-1.3 mg/dL, Mujeres: 0.6-1.1 mg/dL"></textarea>
            </div>

            <!-- Método y Tipo de Muestra -->
            <div class="form-row">
              <div class="form-group">
                <label for="method">Método</label>
                <input 
                  id="method"
                  type="text" 
                  formControlName="method"
                  class="form-control"
                  placeholder="Ej: Espectrofotometría"
                  [class.invalid]="isFieldInvalid('method')">
                <div class="error-message" *ngIf="isFieldInvalid('method')">
                  <span *ngIf="testForm.get('method')?.errors?.['maxlength']">Máximo 100 caracteres</span>
                </div>
              </div>

              <div class="form-group">
                <label for="sampleType">Tipo de Muestra</label>
                <input 
                  id="sampleType"
                  type="text" 
                  formControlName="sampleType"
                  class="form-control"
                  placeholder="Ej: Suero"
                  [class.invalid]="isFieldInvalid('sampleType')">
                <div class="error-message" *ngIf="isFieldInvalid('sampleType')">
                  <span *ngIf="testForm.get('sampleType')?.errors?.['maxlength']">Máximo 50 caracteres</span>
                </div>
              </div>
            </div>

            <!-- Tiempo de Procesamiento, Precio y Orden -->
            <div class="form-row-3">
              <div class="form-group">
                <label for="processingTime">Tiempo (horas)</label>
                <input 
                  id="processingTime"
                  type="number" 
                  formControlName="processingTime"
                  class="form-control"
                  placeholder="0"
                  min="0"
                  [class.invalid]="isFieldInvalid('processingTime')">
                <div class="error-message" *ngIf="isFieldInvalid('processingTime')">
                  <span *ngIf="testForm.get('processingTime')?.errors?.['min']">Debe ser mayor o igual a 0</span>
                </div>
              </div>

              <div class="form-group">
                <label for="price">Precio (L.)</label>
                <input 
                  id="price"
                  type="number" 
                  formControlName="price"
                  class="form-control"
                  placeholder="0.00"
                  step="0.01"
                  min="0"
                  [class.invalid]="isFieldInvalid('price')">
                <div class="error-message" *ngIf="isFieldInvalid('price')">
                  <span *ngIf="testForm.get('price')?.errors?.['min']">Debe ser mayor o igual a 0</span>
                </div>
              </div>

              <div class="form-group">
                <label for="displayOrder">Orden</label>
                <input 
                  id="displayOrder"
                  type="number" 
                  formControlName="displayOrder"
                  class="form-control"
                  placeholder="0"
                  min="0">
              </div>
            </div>

            <!-- Estado Activo -->
            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input 
                  type="checkbox" 
                  formControlName="isActive"
                  class="checkbox-input">
                <span>Prueba activa</span>
              </label>
            </div>

            <!-- Mensajes de error generales -->
            <div class="error-message" *ngIf="submitError">
              {{ submitError }}
            </div>

            <!-- Mensaje de éxito -->
            <div class="success-message" *ngIf="submitSuccess">
              {{ submitSuccess }}
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="onCancel()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="testForm.invalid || isSubmitting">
              {{ isSubmitting ? 'Guardando...' : (isEditMode ? 'Actualizar' : 'Crear') }}
            </button>
          </div>
        </form>
      </div>
    </div>