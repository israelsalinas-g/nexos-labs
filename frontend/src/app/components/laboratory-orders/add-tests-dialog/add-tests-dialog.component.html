<div class="page">

  <!-- Header -->
  <div class="page-header">
    <button class="btn-back" (click)="goBack()">‚Üê Volver a la orden</button>
    <h1>Agregar √≠tems a la orden</h1>
  </div>

  <div class="layout">
    <!-- LEFT: Catalog -->
    <div class="catalog-panel">

      <!-- Tabs -->
      <div class="tab-bar">
        <button class="tab" [class.active]="activeTab() === 'tests'" (click)="setTab('tests')">
          üî¨ Pruebas
          @if (allTests().length) { <span class="tab-count">{{ allTests().length }}</span> }
        </button>
        <button class="tab" [class.active]="activeTab() === 'profiles'" (click)="setTab('profiles')">
          üìã Perfiles
          @if (allProfiles().length) { <span class="tab-count">{{ allProfiles().length }}</span> }
        </button>
        <button class="tab" [class.active]="activeTab() === 'promotions'" (click)="setTab('promotions')">
          üéÅ Promociones
          @if (allPromotions().length) { <span class="tab-count">{{ allPromotions().length }}</span> }
        </button>
      </div>

      <!-- Tab: Pruebas -->
      @if (activeTab() === 'tests') {
        <div class="search-row">
          <input type="text" class="search-input" placeholder="Buscar prueba..."
                 [value]="testSearch()" (input)="onSearch('tests', $any($event.target).value)">
        </div>
        @if (loadingTests()) {
          <p class="loading-msg">Cargando pruebas...</p>
        } @else {
          <div class="items-list">
            @for (t of filteredTests(); track t.id) {
              <label class="item-row" [class.selected]="isSelected('test', t.id)">
                <input type="checkbox" [checked]="isSelected('test', t.id)"
                       (change)="toggle('test', t.id, t.name, t.price)">
                <span class="item-info">
                  <span class="item-name">{{ t.name }}</span>
                  @if (t.code) { <span class="item-code">{{ t.code }}</span> }
                  @if (t.unit) { <span class="item-unit">{{ t.unit }}</span> }
                </span>
                @if (t.price) {
                  <span class="item-price">L. {{ t.price }}</span>
                }
              </label>
            } @empty {
              <p class="empty-msg">No se encontraron pruebas</p>
            }
          </div>
        }
      }

      <!-- Tab: Perfiles -->
      @if (activeTab() === 'profiles') {
        <div class="search-row">
          <input type="text" class="search-input" placeholder="Buscar perfil..."
                 [value]="profileSearch()" (input)="onSearch('profiles', $any($event.target).value)">
        </div>
        @if (loadingProfiles()) {
          <p class="loading-msg">Cargando perfiles...</p>
        } @else {
          <div class="items-list">
            @for (p of filteredProfiles(); track p.id) {
              <label class="item-row" [class.selected]="isSelected('profile', p.id)">
                <input type="checkbox" [checked]="isSelected('profile', p.id)"
                       (change)="toggle('profile', p.id, p.name, p.price)">
                <span class="item-info">
                  <span class="item-name">{{ p.name }}</span>
                  @if (p.code) { <span class="item-code">{{ p.code }}</span> }
                  <span class="item-unit">{{ p.tests?.length || 0 }} pruebas</span>
                </span>
                @if (p.price) {
                  <span class="item-price">L. {{ p.price }}</span>
                }
              </label>
            } @empty {
              <p class="empty-msg">No se encontraron perfiles</p>
            }
          </div>
        }
      }

      <!-- Tab: Promociones -->
      @if (activeTab() === 'promotions') {
        <div class="search-row">
          <input type="text" class="search-input" placeholder="Buscar promoci√≥n..."
                 [value]="promotionSearch()" (input)="onSearch('promotions', $any($event.target).value)">
        </div>
        @if (loadingPromotions()) {
          <p class="loading-msg">Cargando promociones...</p>
        } @else {
          <div class="items-list">
            @for (p of filteredPromotions(); track p.id) {
              <label class="item-row promotion-row" [class.selected]="isSelected('promotion', p.id)">
                <input type="checkbox" [checked]="isSelected('promotion', p.id)"
                       (change)="toggle('promotion', p.id, p.name, p.price)">
                <span class="item-info">
                  <span class="item-name">{{ p.name }}</span>
                  <span class="item-unit">Vigente hasta {{ p.validTo }}</span>
                </span>
                <span class="item-price">L. {{ p.price | number:'1.2-2' }}</span>
              </label>
            } @empty {
              <p class="empty-msg">No hay promociones vigentes</p>
            }
          </div>
        }
      }

    </div>

    <!-- RIGHT: Selection summary -->
    <div class="summary-panel">
      <h3 class="summary-title">√çtems seleccionados <span class="badge">{{ selectedItems().length }}</span></h3>

      @if (selectedItems().length === 0) {
        <p class="empty-msg">Selecciona pruebas, perfiles o promociones del cat√°logo</p>
      } @else {
        <div class="selected-list">
          @for (item of selectedItems(); track item.type + item.id) {
            <div class="selected-item">
              <span class="item-type-icon">
                @if (item.type === 'test') { üî¨ }
                @else if (item.type === 'profile') { üìã }
                @else { üéÅ }
              </span>
              <span class="selected-name">{{ item.name }}</span>
              @if (item.price) {
                <span class="selected-price">L. {{ item.price }}</span>
              }
              <button class="remove-btn" (click)="removeItem(item)">√ó</button>
            </div>
          }
        </div>

        @if (totalPrice() > 0) {
          <div class="total-row">
            <span>Total estimado:</span>
            <strong>L. {{ totalPrice() | number:'1.2-2' }}</strong>
          </div>
        }
      }

      @if (error()) {
        <p class="error-msg">{{ error() }}</p>
      }

      @if (success()) {
        <p class="success-msg">‚úÖ √çtems agregados. Redirigiendo...</p>
      }

      <div class="summary-actions">
        <button class="btn btn-secondary" (click)="goBack()">Cancelar</button>
        <button class="btn btn-primary"
                [disabled]="selectedItems().length === 0 || submitting() || success()"
                (click)="submit()">
          @if (submitting()) { Guardando... }
          @else { Agregar {{ selectedItems().length }} √≠tem(s) }
        </button>
      </div>
    </div>
  </div>
</div>
