@if (visible) {
  <div class="overlay" (click)="close()">
    <div class="dialog" (click)="$event.stopPropagation()">

      <div class="dialog-header">
        <h2 class="dialog-title">ğŸ“¤ Enviar Resultados al Paciente</h2>
        <button class="close-btn" (click)="close()" [disabled]="sending()">Ã—</button>
      </div>

      @if (!result()) {
        <div class="dialog-body">
          <p class="dialog-subtitle">Selecciona los canales por los que deseas enviar los resultados.</p>

          <!-- Canal: Email -->
          <label class="channel-row" [class.disabled]="!hasEmail()">
            <input type="checkbox"
                   [checked]="emailSelected()"
                   [disabled]="!hasEmail()"
                   (change)="toggleEmail()">
            <span class="channel-icon">ğŸ“§</span>
            <span class="channel-info">
              <span class="channel-label">Email</span>
              @if (hasEmail()) {
                <span class="channel-value">{{ patientEmail() }}</span>
              } @else {
                <span class="channel-unavailable">El paciente no tiene email registrado</span>
              }
            </span>
          </label>

          <!-- Canal: WhatsApp -->
          <label class="channel-row" [class.disabled]="!hasPhone()">
            <input type="checkbox"
                   [checked]="whatsappSelected()"
                   [disabled]="!hasPhone()"
                   (change)="toggleWhatsapp()">
            <span class="channel-icon">ğŸ“±</span>
            <span class="channel-info">
              <span class="channel-label">WhatsApp</span>
              @if (hasPhone()) {
                <span class="channel-value">{{ patientPhone() }}</span>
              } @else {
                <span class="channel-unavailable">El paciente no tiene telÃ©fono registrado</span>
              }
            </span>
          </label>
        </div>

        <div class="dialog-footer">
          <button class="btn btn-secondary" (click)="close()" [disabled]="sending()">
            Cancelar
          </button>
          <button class="btn btn-primary" (click)="submit()" [disabled]="!canSubmit()">
            @if (sending()) { Enviando... }
            @else { Enviar }
          </button>
        </div>

      } @else {
        <!-- Resultado del envÃ­o -->
        <div class="dialog-body result-body">
          @if (result()!.emailSent) {
            <div class="result-row success">âœ… Email enviado correctamente</div>
          }
          @if (result()!.whatsappSent) {
            <div class="result-row success">âœ… WhatsApp enviado correctamente</div>
          }
          @for (err of result()!.errors; track err) {
            <div class="result-row error">âŒ {{ err }}</div>
          }
          @if (!result()!.emailSent && !result()!.whatsappSent && result()!.errors.length === 0) {
            <div class="result-row warn">âš ï¸ No se seleccionaron canales vÃ¡lidos</div>
          }
        </div>
        <div class="dialog-footer">
          <button class="btn btn-secondary" (click)="close(true)">Cerrar</button>
        </div>
      }

    </div>
  </div>
}
