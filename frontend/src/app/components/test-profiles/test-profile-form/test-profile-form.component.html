
    <div class="modal-overlay" (click)="onCancel()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ isEditMode ? 'Editar Perfil' : 'Nuevo Perfil' }}</h2>
          <button class="close-btn" (click)="onCancel()">&times;</button>
        </div>

        <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">
          <div class="form-body">
            <!-- Categoría -->
            <div class="form-group">
              <label for="sectionId" class="required">Sección</label>
              <select
                id="sectionId"
                formControlName="sectionId"
                class="form-control"
                (change)="onSectionChange()"
                [class.invalid]="isFieldInvalid('sectionId')">
                <option value="">Seleccione una sección</option>
                <option *ngFor="let category of categories" [value]="category.id">
                  {{ category.name }}
                </option>
              </select>
              <div class="error-message" *ngIf="isFieldInvalid('sectionId')">
                <span *ngIf="profileForm.get('sectionId')?.errors?.['required']">La sección es requerida</span>
              </div>
            </div>

            <!-- Nombre y Código -->
            <div class="form-row">
              <div class="form-group">
                <label for="name" class="required">Nombre</label>
                <input 
                  id="name"
                  type="text" 
                  formControlName="name"
                  class="form-control"
                  placeholder="Ej: Curva de tolerancia a la glucosa"
                  [class.invalid]="isFieldInvalid('name')">
                <div class="error-message" *ngIf="isFieldInvalid('name')">
                  <span *ngIf="profileForm.get('name')?.errors?.['required']">El nombre es requerido</span>
                  <span *ngIf="profileForm.get('name')?.errors?.['minlength']">Mínimo 2 caracteres</span>
                  <span *ngIf="profileForm.get('name')?.errors?.['maxlength']">Máximo 150 caracteres</span>
                </div>
              </div>

              <div class="form-group">
                <label for="code">Código</label>
                <input 
                  id="code"
                  type="text" 
                  formControlName="code"
                  class="form-control"
                  placeholder="Ej: CTG"
                  [class.invalid]="isFieldInvalid('code')">
                <div class="error-message" *ngIf="isFieldInvalid('code')">
                  <span *ngIf="profileForm.get('code')?.errors?.['maxlength']">Máximo 20 caracteres</span>
                </div>
              </div>
            </div>

            <!-- Descripción -->
            <div class="form-group">
              <label for="description">Descripción</label>
              <textarea 
                id="description"
                formControlName="description"
                class="form-control"
                rows="2"
                placeholder="Descripción del perfil"></textarea>
            </div>

            <!-- Selección de Pruebas -->
            <div class="form-group">
              <label class="required">Pruebas del Perfil</label>
              <div class="tests-selector">
                <div *ngIf="availableTests.length === 0" class="no-tests-message">
                  {{ loadingTests ? 'Cargando pruebas...' : 'Seleccione una categoría para ver las pruebas disponibles' }}
                </div>
                <div *ngIf="availableTests.length > 0" class="tests-list">
                  <div class="test-checkbox" *ngFor="let test of availableTests">
                    <label class="checkbox-label">
                      <input 
                        type="checkbox" 
                        [checked]="isTestSelected(test.id)"
                        (change)="toggleTest(test.id)"
                        class="checkbox-input">
                      <span>{{ test.name }}</span>
                      <span class="test-details" *ngIf="test.code || test.unit">
                        ({{ test.code }}{{ test.unit ? ' - ' + test.unit : '' }})
                      </span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="error-message" *ngIf="selectedTestIds.length === 0 && (profileForm.touched || submitAttempted)">
                Debe seleccionar al menos una prueba
              </div>
              <div class="selected-count" *ngIf="selectedTestIds.length > 0">
                {{ selectedTestIds.length }} prueba(s) seleccionada(s)
              </div>
            </div>

            <!-- Precio y Orden -->
            <div class="form-row">
              <div class="form-group">
                <label for="price">Precio (L.)</label>
                <input 
                  id="price"
                  type="number" 
                  formControlName="price"
                  class="form-control"
                  placeholder="0.00"
                  step="0.01"
                  min="0"
                  [class.invalid]="isFieldInvalid('price')">
                <div class="error-message" *ngIf="isFieldInvalid('price')">
                  <span *ngIf="profileForm.get('price')?.errors?.['min']">Debe ser mayor o igual a 0</span>
                </div>
              </div>

              <div class="form-group">
                <label for="displayOrder">Orden</label>
                <input 
                  id="displayOrder"
                  type="number" 
                  formControlName="displayOrder"
                  class="form-control"
                  placeholder="0"
                  min="0">
              </div>
            </div>

            <!-- Estado Activo -->
            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input 
                  type="checkbox" 
                  formControlName="isActive"
                  class="checkbox-input">
                <span>Perfil activo</span>
              </label>
            </div>

            <!-- Mensajes de error generales -->
            <div class="error-message" *ngIf="submitError">
              {{ submitError }}
            </div>

            <!-- Mensaje de éxito -->
            <div class="success-message" *ngIf="submitSuccess">
              {{ submitSuccess }}
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="onCancel()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="profileForm.invalid || selectedTestIds.length === 0 || isSubmitting">
              {{ isSubmitting ? 'Guardando...' : (isEditMode ? 'Actualizar' : 'Crear') }}
            </button>
          </div>
        </form>
      </div>
    </div>