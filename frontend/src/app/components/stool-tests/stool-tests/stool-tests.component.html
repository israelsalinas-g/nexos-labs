<div class="container">
  <div class="header">
    <div class="header-left">
      <h1><i class="fas fa-microscope"></i> Ex√°menes Coprol√≥gicos</h1>
    </div>
    <button class="btn btn-primary" (click)="createNewTest()">
      <i class="fas fa-plus"></i> Nuevo Examen
    </button>
  </div>

  <!-- Filters -->
  @if (!loading() && !error()) {
  <div class="filters">
    <div class="filter-group">
      <label for="patientIdSearch">ID Paciente:</label>
      <input id="patientIdSearch" type="text" [ngModel]="filters().patientId"
        (ngModelChange)="updateFilters({patientId: $event})" placeholder="ID del paciente..."
        (input)="onFilterChange()">
    </div>

    <div class="filter-group">
      <label for="statusFilter">Estado:</label>
      <select id="statusFilter" [ngModel]="filters().status"
        (ngModelChange)="updateFilters({status: $event}); onFilterChange()">
        <option value="">Todos los estados</option>
        <option value="pending">Pendiente</option>
        <option value="completed">Completado</option>
        <option value="reviewed">Revisado</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="dateFrom">Desde:</label>
      <input id="dateFrom" type="date" [ngModel]="filters().dateFrom"
        (ngModelChange)="updateFilters({dateFrom: $event}); onFilterChange()">
    </div>

    <div class="filter-group">
      <label for="dateTo">Hasta:</label>
      <input id="dateTo" type="date" [ngModel]="filters().dateTo"
        (ngModelChange)="updateFilters({dateTo: $event}); onFilterChange()">
    </div>

    <div class="filter-actions">
      <button class="btn btn-secondary" (click)="clearFilters()">
        <i class="fas fa-filter"></i> Limpiar Filtros
      </button>
      <button class="btn btn-secondary" (click)="refreshData()">
        <i class="fas fa-sync-alt"></i> Actualizar
      </button>
    </div>
  </div>
  }

  <!-- Loading State -->
  @if (loading()) {
  <div class="loading">
    <i class="fas fa-spinner fa-spin"></i> Cargando ex√°menes coprol√≥gicos...
  </div>
  }

  <!-- Error State -->
  @if (error()) {
  <div class="error">
    ‚ùå Error al cargar los ex√°menes: {{ error() }}
    <br><small>Verifica que el backend est√© ejecut√°ndose en http://localhost:3000</small>
  </div>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && stoolTests().length === 0) {
  <div class="no-data">
    üìã No se encontraron ex√°menes coprol√≥gicos.
    <br><small>Crea el primer examen haciendo clic en "Nuevo Examen".</small>
  </div>
  }

  <!-- Results Table -->
  @if (!loading() && !error() && stoolTests().length > 0) {
  <div class="table-container">
    <table class="results-table">
      <thead>
        <tr>
          <th>Muestra</th>
          <th>Paciente</th>
          <th>Edad</th>
          <th>Fecha</th>
          <th>Estado</th>
          <th>Hallazgos</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (test of stoolTests(); track test.id) {
        <tr (click)="viewTest(test)" class="test-row" [class.abnormal-row]="hasAbnormalFindings(test)"
          [class.inactive-row]="!test.isActive">
          <td>
            <div class="sample-info">
              <strong>{{ test.sampleNumber }}</strong>
            </div>
          </td>
          <td>
            <div class="patient-info">
              <strong>{{ test.patient.name }}</strong>
            </div>
          </td>
          <td>{{ test.patient.age || 'N/A' }}</td>
          <td>{{ formatDate(test.testDate) }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(test.status)">
              {{ getStatusText(test.status) }}
            </span>
          </td>
          <td>
            <div class="findings-summary">
              <span class="finding-tag"
                [ngClass]="'color-' + ((test.color && test.color.toLowerCase()) || 'unknown')">{{ test.color || 'No
                especificado' }}</span>
              <span class="finding-tag">{{ test.consistency || 'No especificado' }}</span>
              @if (hasAbnormalFindings(test)) {
              <span class="finding-tag abnormal">
                ‚ö†Ô∏è Anormal
              </span>
              }
            </div>
          </td>
          <td class="actions">
            <button class="action-btn view-btn" (click)="viewTest(test, $event)" title="Ver detalles">
              üëÅÔ∏è Ver
            </button>
            <button class="action-btn edit-btn" (click)="editTest(test, $event)" title="Editar examen">
              ‚úèÔ∏è Editar
            </button>
            <button class="action-btn" [class.status-active-btn]="test.isActive"
              [class.status-inactive-btn]="!test.isActive" (click)="deleteTest(test.id); $event.stopPropagation()"
              [title]="test.isActive ? 'Desactivar examen' : 'Activar examen'">
              {{ test.isActive ? 'üóëÔ∏è Desactivar' : 'üü¢ Activar' }}
            </button>
            <button class="action-btn pdf-btn" (click)="generatePdf(test, $event)" title="Generar PDF">
              üñ®Ô∏è PDF
            </button>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  }

  <!-- Pagination -->
  @if (!loading() && !error() && totalPages() > 1) {
  <div class="pagination">
    <button class="btn" [disabled]="currentPage() === 1" (click)="goToPage(currentPage() - 1)">
      ‚Üê Anterior
    </button>

    <span class="page-info">
      P√°gina {{ currentPage() }} de {{ totalPages() }}
      ({{ totalTests() }} ex√°menes totales)
    </span>

    <button class="btn" [disabled]="currentPage() === totalPages()" (click)="goToPage(currentPage() + 1)">
      Siguiente ‚Üí
    </button>
  </div>
  }

  <!-- Modal de confirmaci√≥n -->
  @if (showConfirmModal()) {
  <div class="modal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>{{ confirmAction().title }}</h3>
      <p>{{ confirmAction().message }}</p>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeModal()">Cancelar</button>
        <button class="btn-danger" (click)="confirmAction().action()">Confirmar</button>
      </div>
    </div>
  </div>
  }
</div>